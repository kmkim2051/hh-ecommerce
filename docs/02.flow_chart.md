# Flow Chart

## ì£¼ë¬¸ ë„ë©”ì¸

```mermaid
flowchart TD
    Start([ì£¼ë¬¸ ë„ë©”ì¸]) --> Action{API í˜¸ì¶œ}
    
    Action -->|ì£¼ë¬¸ ìƒì„±| TxStart[ğŸ”’ íŠ¸ëœì­ì…˜ ì‹œì‘]
    
    TxStart --> Step1[1. ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ]
    Step1 --> Step2[2. ì¬ê³  ê²€ì¦<br/>ğŸ”’ ë™ì‹œì„± ì œì–´]
    Step2 --> StockOK{ì¬ê³  ì¶©ë¶„?}
    StockOK -->|No| Rollback1[âŒ ì „ì²´ ë¡¤ë°±]
    Rollback1 --> Fail1[ì¬ê³  ë¶€ì¡± ì‹¤íŒ¨]
    
    StockOK -->|Yes| Step3[3. ì¿ í° ê²€ì¦<br/>ê°„ë‹¨í•œ ì¡°ê±´ë¬¸]
    Step3 --> CouponOK{ì¿ í° ìœ íš¨?}
    CouponOK -->|No| Rollback2[âŒ ì „ì²´ ë¡¤ë°±]
    Rollback2 --> Fail2[ì¿ í° ë¬´íš¨ ì‹¤íŒ¨]
    
    CouponOK -->|Yes| Step4[4. í¬ì¸íŠ¸ ì”ì•¡ í™•ì¸]
    Step4 --> BalanceOK{ì”ì•¡ ì¶©ë¶„?}
    BalanceOK -->|No| Rollback3[âŒ ì „ì²´ ë¡¤ë°±]
    Rollback3 --> Fail3[ì”ì•¡ ë¶€ì¡± ì‹¤íŒ¨]
    
    BalanceOK -->|Yes| Step5[5. Order ìƒì„±]
    Step5 --> Step6[6. OrderItem ìƒì„±<br/>ğŸ“¸ ìŠ¤ëƒ…ìƒ· ì €ì¥]
    Step6 --> Step7[7. ì¬ê³  ì°¨ê°<br/>stock_quantity -= N]
    Step7 --> Step8[8. í¬ì¸íŠ¸ ì°¨ê°<br/>balance -= total]
    Step8 --> Step9[9. PointTransaction ê¸°ë¡]
    Step9 --> Step10{ì¿ í° ì‚¬ìš©?}
    Step10 -->|Yes| Step11[10. CouponUser ì—…ë°ì´íŠ¸]
    Step10 -->|No| Step12
    Step11 --> Step12[11. ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°]
    Step12 --> Step13[12. Outbox ì €ì¥]
    Step13 --> TxCommit[âœ… íŠ¸ëœì­ì…˜ ì»¤ë°‹]
    TxCommit --> Success1[ì£¼ë¬¸ ìƒì„± ì™„ë£Œ]
    
    Action -->|ì£¼ë¬¸ ì·¨ì†Œ| CancelTxStart[ğŸ”’ íŠ¸ëœì­ì…˜ ì‹œì‘]
    CancelTxStart --> Cancel1[1. Order ì¡°íšŒ]
    Cancel1 --> Cancel2[2. ì¬ê³  ë³µì›<br/>stock_quantity += N]
    Cancel2 --> Cancel3[3. í¬ì¸íŠ¸ í™˜ë¶ˆ<br/>balance += total]
    Cancel3 --> Cancel4[4. PointTransaction ê¸°ë¡<br/>type: REFUND]
    Cancel4 --> Cancel5{ì¿ í° ì‚¬ìš©í–ˆë‚˜?}
    Cancel5 -->|Yes| Cancel6[5. ì¿ í° ë³µì›]
    Cancel5 -->|No| Cancel7
    Cancel6 --> Cancel7[6. Order status ë³€ê²½<br/>CANCELED]
    Cancel7 --> CancelTxCommit[âœ… íŠ¸ëœì­ì…˜ ì»¤ë°‹]
    CancelTxCommit --> Success2[ì£¼ë¬¸ ì·¨ì†Œ ì™„ë£Œ]
    
    Fail1 --> End([ì¢…ë£Œ])
    Fail2 --> End
    Fail3 --> End
    Success1 --> End
    Success2 --> End
```

## ì¿ í° ë„ë©”ì¸

```mermaid
flowchart TD
    Start([ì¿ í° ë„ë©”ì¸]) --> Action{API í˜¸ì¶œ}
    
    Action -->|ì¿ í° ë°œê¸‰| TxStart[ğŸ”’ íŠ¸ëœì­ì…˜ ì‹œì‘<br/>âš¡ Pessimistic Lock]
    
    TxStart --> Step1[1. Coupon ì¡°íšŒ<br/>ğŸ”’ FOR UPDATE]
    Step1 --> Step2{ìˆ˜ëŸ‰ ìˆìŒ?}
    Step2 -->|No| Rollback[âŒ íŠ¸ëœì­ì…˜ ë¡¤ë°±]
    Rollback --> Fail[í’ˆì ˆ ì‹¤íŒ¨]
    
    Step2 -->|Yes| Step3[2. available_quantity--<br/>âš¡ ë™ì‹œì„± ì œì–´ í•µì‹¬]
    Step3 --> Step4{ìˆ˜ëŸ‰ì´ 0?}
    Step4 -->|Yes| Step5[3. status = SOLD_OUT]
    Step4 -->|No| Step6
    Step5 --> Step6[4. CouponUser ìƒì„±]
    Step6 --> TxCommit[âœ… íŠ¸ëœì­ì…˜ ì»¤ë°‹<br/>ğŸ”“ Lock í•´ì œ]
    TxCommit --> Success[ë°œê¸‰ ì™„ë£Œ]
    
    Fail --> End([ì¢…ë£Œ])
    Success --> End
```

## í¬ì¸íŠ¸ ë„ë©”ì¸

```mermaid
flowchart TD
    Start([í¬ì¸íŠ¸ ë„ë©”ì¸]) --> Action{API í˜¸ì¶œ}
    
    Action -->|í¬ì¸íŠ¸ ì¶©ì „| TxStart[ğŸ”’ íŠ¸ëœì­ì…˜ ì‹œì‘]
    TxStart --> Step1[1. Point ì¡°íšŒ/ìƒì„±]
    Step1 --> Step2[2. balance ì¦ê°€]
    Step2 --> Step3[3. PointTransaction ê¸°ë¡<br/>type: CHARGE]
    Step3 --> TxCommit[âœ… íŠ¸ëœì­ì…˜ ì»¤ë°‹]
    TxCommit --> Success[ì¶©ì „ ì™„ë£Œ]
    
    Success --> End([ì¢…ë£Œ])
```