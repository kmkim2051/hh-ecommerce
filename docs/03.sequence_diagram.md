# Sequence Diagrams Documentation

---

## 1. 주문 프로세스 Sequence Diagram

```mermaid
---
config:
  theme: neutral
---
sequenceDiagram
    participant Client
    participant OrderController
    participant OrderFacade
    participant CartService
    participant ProductService
    participant CouponService
    participant PointService
    participant OrderService
    participant OutboxService
    Client->>OrderController: POST /orders
    OrderController->>OrderFacade: createOrder(userId, request)
    Note over OrderFacade: 트랜잭션 시작
    OrderFacade->>CartService: getCartItems(cartItemIds)
    CartService-->>OrderFacade: List<CartItem>
    loop 각 장바구니 상품에 대해
        OrderFacade->>ProductService: validateStock(productId, quantity)
        ProductService-->>OrderFacade: throw InvalidCouponException
        alt 재고 부족
            Note over OrderFacade: 일부 재고 품절시 전체 롤백
            OrderFacade-->>OrderController: throw InvalidOrderStateException
            OrderController-->>Client: 400 Bad Request (재고 부족)
        end
    end
    alt 쿠폰 사용하는 경우
        OrderFacade->>CouponService: validateCoupon(couponUserId)
        CouponService-->>OrderFacade: CouponUser
        alt 쿠폰이 유효하지 않음
            OrderFacade-->>OrderController: throw InvalidCouponException
            OrderController-->>Client: 400 Bad Request (쿠폰 사용 불가)
        end
        OrderFacade->>OrderFacade: calculateDiscountAmount(coupon)
    end
    OrderFacade->>OrderFacade: calculateTotalPrice(cartItems, discount)
    OrderFacade->>PointService: validateBalance(userId, totalPrice)
    PointService-->>OrderFacade: boolean
    alt 잔액 부족
        OrderFacade-->>OrderController: throw InsufficientBalanceException
        OrderController-->>Client: 400 Bad Request (잔액 부족)
    end
    OrderFacade->>OrderService: createOrder(userId, totalPrice)
    OrderService-->>OrderFacade: Order (status: PENDING)
    loop 각 장바구니 상품에 대해
        OrderFacade->>OrderService: createOrderItem(orderId, cartItem, product)
        OrderService-->>OrderFacade: OrderItem
        OrderFacade->>ProductService: decreaseStock(productId, quantity)
        ProductService-->>OrderFacade: void
    end
    OrderFacade->>PointService: usePoint(userId, totalPrice, orderId)
    Note over PointService: balance 차감<br/>PointTransaction 기록
    PointService-->>OrderFacade: void
    alt 쿠폰 사용한 경우
        OrderFacade->>CouponService: useCoupon(couponUserId, orderId)
        CouponService-->>OrderFacade: void
    end
    OrderFacade->>OrderService: updateOrderStatus(orderId, PAID)
    OrderService-->>OrderFacade: void
    OrderFacade-->>OutboxService: saveOutboxEvent(orderId)
    Note over OutboxService: 외부 전송
    OutboxService-->>OrderFacade: OutboxEvent
    Note over OrderFacade: 트랜잭션 커밋
    OrderFacade-->>OrderController: OrderResponse
    OrderController-->>Client: 201 Created

```

**요약**
1. 사용자가 장바구니 상품을 선택하여 주문을 요청한다. 쿠폰 ID는 선택적으로 전달된다.
2. 장바구니 서비스가 선택된 상품 목록을 조회한다.
3. 각 상품에 대해 재고를 검증하며, 하나라도 재고가 부족하면 전체 주문이 롤백된다.
4. 쿠폰이 있다면 유효성을 검증하고 할인 금액을 계산한다.
5. 총 주문 금액을 계산하고 포인트 잔액이 충분한지 확인한다.
6. 주문과 주문 아이템을 생성하고, 각 상품의 재고를 차감한다.
7. 포인트 서비스가 사용자 잔액을 차감하고 거래 내역을 기록한다.
8. 쿠폰을 사용한 경우 쿠폰 사용 처리를 한다.
9. 주문 상태를 PAID로 변경하고 Outbox 이벤트를 저장하여 외부 시스템에 전송한다.
10. 모든 작업이 성공하면 트랜잭션을 커밋하고 최종 결과를 사용자에게 반환한다.

---

## 2. 주문 취소 Sequence Diagram

```mermaid
---
config:
  theme: neutral
---
sequenceDiagram
    participant Client
    participant OrderController
    participant OrderFacade
    participant OrderService
    participant ProductService
    participant PointService
    participant CouponService
    Client->>OrderController: POST /orders/{id}/cancel
    OrderController->>OrderFacade: cancelOrder(orderId)
    OrderFacade->>OrderService: getOrder(orderId)
    OrderService-->>OrderFacade: Order
    alt 취소 불가능한 상태
        OrderFacade->>OrderFacade: validateCancelable(order.status)
        OrderFacade-->>OrderController: throw InvalidOrderStatusException
        Note over OrderFacade: ❌ 트랜잭션 롤백
        OrderController-->>Client: 400 Bad Request (취소 불가)
    end
    OrderFacade->>OrderService: getOrderItems(orderId)
    OrderService-->>OrderFacade: List<OrderItem>
    Note over OrderFacade: 검증 통과
    loop 각 주문 아이템에 대해
        OrderFacade->>OrderService: updateOrderItemStatus(orderItemId, CANCELED)
        OrderService-->>OrderFacade: void
        OrderFacade->>ProductService: increaseStock(productId, quantity)
        ProductService-->>OrderFacade: void
    end
    OrderFacade->>PointService: refundPoint(userId, order.totalPrice, orderId)
    Note over PointService: balance 증가<br/>PointTransaction 기록<br/>type: REFUND
    PointService-->>OrderFacade: void
    alt 쿠폰을 사용한 주문인 경우
        OrderFacade->>OrderService: findUsedCoupon(orderId)
        OrderService-->>OrderFacade: CouponUser (nullable)
        alt 쿠폰 사용 이력 있음
            OrderFacade->>CouponService: restoreCoupon(couponUserId)
            Note over CouponService: 쿠폰 복원
            CouponService-->>OrderFacade: void
        end
    end
    OrderFacade->>OrderService: updateOrderStatus(orderId, CANCELED)
    OrderService-->>OrderFacade: void
    OrderFacade-->>OrderController: void
    OrderController-->>Client: 200 OK
```

**요약**
1. 사용자가 특정 주문에 대해 취소를 요청한다.
2. 주문 정보를 조회하고 취소 가능한 상태인지 검증한다.
3. 취소 불가능한 상태인 경우 예외를 발생시키고 트랜잭션을 롤백한다.
4. 각 주문 아이템의 상태를 CANCELED로 변경하고 상품 재고를 복원한다.
5. 포인트 서비스가 주문 금액을 환불하고 REFUND 타입의 거래 내역을 기록한다.
6. 쿠폰을 사용한 주문인 경우 쿠폰을 복원한다.
7. 주문 상태를 CANCELED로 변경하고 최종 결과를 사용자에게 반환한다.

---

## 3. 선착순 쿠폰 발행 Sequence Diagram

```mermaid
---
config:
  theme: neutral
---
sequenceDiagram
    participant Client
    participant CouponController
    participant CouponService
    participant CouponRepository
    participant CouponUserRepository
    Client->>CouponController: POST /coupons/{couponId}/issue
    CouponController->>CouponService: issueCoupon(userId, couponId)
    CouponService->>CouponRepository: findByIdWithLock(couponId)
    CouponRepository-->>CouponService: Coupon (pessimistic lock)
    alt 쿠폰이 없는 경우
        CouponService-->>CouponController: throw CouponNotFoundException
        CouponController-->>Client: 404 Not Found
    end
    alt 쿠폰이 활성 상태가 아님
        CouponService->>CouponService: check status != ACTIVE
        CouponService-->>CouponController: throw CouponNotAvailableException
        CouponController-->>Client: 400 Bad Request (발급 불가)
    end
    alt 수량 소진
        CouponService->>CouponService: check available_quantity <= 0
        CouponService-->>CouponController: throw CouponSoldOutException
        CouponController-->>Client: 400 Bad Request (품절)
    end
    alt 이미 발급받은 경우
        CouponService->>CouponUserRepository: existsByUserIdAndCouponId(userId, couponId)
        CouponUserRepository-->>CouponService: true
        CouponService-->>CouponController: throw AlreadyIssuedException
        CouponController-->>Client: 400 Bad Request (이미 발급)
    end
    CouponService->>CouponRepository: decreaseAvailableQuantity(couponId)
    CouponRepository-->>CouponService: Coupon (updated)
    alt 수량이 0이 된 경우
        CouponService->>CouponService: check available_quantity == 0
        CouponService->>CouponRepository: updateStatus(couponId, SOLD_OUT)
        CouponRepository-->>CouponService: void
    end
    CouponService->>CouponUserRepository: save(CouponUser)
    CouponUserRepository-->>CouponService: CouponUser
    CouponService-->>CouponController: CouponUserResponse
    CouponController-->>Client: 201 Created

```
**요약**
1. 사용자가 특정 쿠폰에 대해 발급을 요청한다.
2. Pessimistic Lock으로 쿠폰을 조회하여 동시성 제어를 수행한다.
3. 쿠폰이 존재하지 않거나 활성 상태가 아닌 경우 예외를 발생시킨다.
4. 쿠폰 수량이 소진되었거나 이미 발급받은 경우 예외를 발생시킨다.
5. 쿠폰의 잔여 수량을 1 감소시킨다.
6. 수량이 0이 된 경우 쿠폰 상태를 SOLD_OUT으로 변경한다.
7. 사용자별 쿠폰 발급 정보를 저장하고 최종 결과를 사용자에게 반환한다.


---

## 4. 포인트 충전 Sequence Diagram

```mermaid
sequenceDiagram
    participant Client
    participant PointController
    participant PointService
    participant PointRepository
    participant PointTransactionRepository

    Client->>PointController: POST /points/charge
    PointController->>PointService: chargePoint(userId, request)
        
    PointService->>PointRepository: findByUserId(userId)
    PointRepository-->>PointService: Point
    
    alt 포인트 최초 생성인 경우
        PointService->>PointRepository: save(new Point for userId)
        PointRepository-->>PointService: Point (created)
    end
    
    alt 충전 금액이 유효하지 않음
        PointService->>PointService: check amount <= 0
        PointService-->>PointController: throw InvalidAmountException
        PointController-->>Client: 400 Bad Request (잘못된 금액)
    end
    
    PointService->>PointRepository: increaseBalance(pointId, amount)
    PointRepository-->>PointService: Point (updated)
    
    PointService->>PointTransactionRepository: save(type: CHARGE, amount, balance_after)
    PointTransactionRepository-->>PointService: PointTransaction
        
    PointService-->>PointController: PointResponse
    PointController-->>Client: 200 OK
```

**요약**
1. 사용자가 포인트 충전을 요청한다.
2. 사용자의 포인트 계좌를 조회한다.
3. 포인트 계좌가 없는 경우 새로 생성한다.
4. 충전 금액이 0 이하인 경우 예외를 발생시킨다.
5. 포인트 잔액을 충전 금액만큼 증가시킨다.
6. CHARGE 타입의 포인트 거래 내역을 저장하고 최종 결과를 사용자에게 반환한다.