

동시성 통합 테스트 강화 계획

1. 쿠폰

테스트 목표
•	발급 시 초과 발급 방지
•	사용 시 중복 사용 방지

시나리오 예시

테스트 케이스,	상황,	기대 결과
'발급 동시성',	'n명의 스레드가 동일 쿠폰 ID를 동시에 발급 요청',	'발급 가능 수량 초과하지 않음, 초과 요청은 예외 발생'
'발급-사용 혼합',	'발급 스레드와 사용 스레드가 동시에 실행',	'사용 가능한 쿠폰만 발급/사용 가능, race condition 발생 안함'
'사용자별 사용',	'동일 사용자가 여러 요청으로 쿠폰 사용 시',	'이중 사용 방지, 낙관적 락 충돌 시 재시도 후 정상 처리'

Tip: CountDownLatch 또는 CyclicBarrier를 사용하여 스레드 동기화 후 동시에 실행하도록 구성

⸻

2. 포인트

테스트 목표
•	충전/사용 시 잔액 일관성 유지
•	이중 사용 방지

시나리오 예시

'테스트 케이스',	'상황',	'기대 결과'
'동시 충전',	'동일 사용자 포인트를 여러 스레드가 동시에 충전',	'최종 잔액 = 각 충전 합산'
'동시 사용',	'동일 사용자 포인트 여러 요청으로 사용',	'잔액 음수 방지, 이중 사용 방지, 낙관적 락 충돌 발생 시 재시도 후 정상'
'충전+사용 혼합',	'충전과 사용이 동시에 발생',	'잔액 정확성 유지, 재시도 로직 정상 작동'

Tip: 충전/사용 트랜잭션 블록 단위로 TransactionTemplate 이용, 낙관적 락 충돌을 일부러 발생시켜 재시도 검증

⸻

3. 상품 재고

테스트 목표
•	재고 초과 판매 방지
•	한정 수량 이벤트 안정성 확인

시나리오 예시

'테스트 케이스',	'상황',	'기대 결과'
'단일 상품 동시 주문',	'동일 상품 여러 스레드가 동시에 구매 요청',	'재고 0 초과 방지, 초과 주문은 예외 처리'
'다중 상품 동시 주문',	'서로 다른 상품에 대해 여러 요청',	'충돌 없음, 각 상품 재고 정상 감소'
'이벤트 상품',	'재고 n개 한정 상품, 다수 요청 발생',	'선착순 n명만 주문 성공, 나머지는 예외 처리'

Tip: 비관적 락 적용 시 트랜잭션을 길게 유지해서 실제 경합 상황 재현

⸻

4. 공통 고려 사항
   •	동시성 테스트 환경
   •	실제 DB (TestContainer 기반 MySQL)에서 테스트
   •	강제 race condition
   •	Thread.sleep()으로 트랜잭션 중단점을 만들어 경합 상황 발생
   •	의도적으로 버전 충돌 유발하여 재시도 로직 검증
   •	결과 검증
   •	최종 상태: 재고, 쿠폰, 포인트 합계가 예상 값과 일치
   •	로그 확인: 낙관적 락 충돌 발생 및 재시도 정상
   •	지속적 반복
   •	재현 가능성 높은 환경에서 반복 실행 (100~1000회 반복)
   ⸻

