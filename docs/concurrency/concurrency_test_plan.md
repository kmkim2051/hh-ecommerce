# 동시성 통합 테스트 강화 계획

## 1. 쿠폰

### 테스트 목표
- 발급 시 초과 발급 방지
- 사용 시 중복 사용 방지

### 시나리오 예시

| 테스트 케이스 | 상황 | 기대 결과 |
|---------------|------|------------|
| 발급 동시성 | n명의 스레드가 동일 쿠폰 ID를 동시에 발급 요청 | 발급 가능 수량 초과하지 않음, 초과 요청은 예외 발생 |
| 발급-사용 혼합 | 발급 스레드와 사용 스레드가 동시에 실행 | 사용 가능한 쿠폰만 정상 발급/사용, race condition 없음 |
| 사용자별 사용 | 동일 사용자가 여러 요청으로 쿠폰 사용 시 | 이중 사용 방지, 낙관적 락 충돌 시 재시도 후 정상 처리 |

**Tip:** `CountDownLatch` 또는 `CyclicBarrier`를 사용하여 모든 스레드를 동기화 후 동시에 실행.

---

## 2. 포인트

### 테스트 목표
- 충전/사용 시 잔액 일관성 유지
- 포인트 이중 사용 방지

### 시나리오 예시

| 테스트 케이스 | 상황 | 기대 결과 |
|---------------|------|------------|
| 동시 충전 | 동일 사용자에게 여러 스레드가 동시에 충전 | 최종 잔액 = 모든 충전 값의 합 |
| 동시 사용 | 동일 사용자 포인트를 여러 요청이 동시에 사용 | 잔액 음수 방지, 이중 사용 방지, 낙관적 락 충돌 시 재시도 |
| 충전+사용 혼합 | 충전과 사용이 동시에 발생 | 잔액 정확성 유지, 재시도 로직 정상 동작 |

**Tip:** `TransactionTemplate`을 이용해 트랜잭션 제어. 낙관적 락 충돌을 일부러 발생시켜 재시도 로직을 검증.

---

## 3. 상품 재고

### 테스트 목표
- 재고 초과 판매 방지
- 한정 수량 이벤트 시 안정적 동작 검증

### 시나리오 예시

| 테스트 케이스 | 상황 | 기대 결과 |
|---------------|------|------------|
| 단일 상품 동시 주문 | 동일 상품을 여러 스레드가 동시에 구매 | 재고 0 이하로 내려가지 않음, 초과 주문은 예외 |
| 다중 상품 동시 주문 | 서로 다른 상품에 대해 동시 주문 | 충돌 없음, 상품별 재고 정상 감소 |
| 이벤트 상품 | 재고 n개 한정 이벤트 상품에 다수 요청 발생 | 선착순 n명만 성공, 이후 요청은 예외 |

**Tip:** 비관적 락 사용 시 트랜잭션을 길게 유지하여 실제 경합 상황을 재현.

---

## 4. 공통 고려 사항

### 동시성 테스트 환경
- 실제 DB 기반 테스트 (TestContainers + MySQL 권장)

### 강제 race condition 유발
- 트랜잭션 내부에서 `Thread.sleep()` 사용해 경합 지점 생성
- 의도적으로 낙관적 락 버전 충돌을 만들어 재시도 검증

### 결과 검증
- 최종 재고/포인트/쿠폰 상태가 정확한지 확인
- 로그에서 낙관적 락 충돌 발생 및 재시도 흐름 검증

### 지속적 반복
- 재현성 높은 환경에서 동일 테스트를 100~1000회 반복 실행하여 안정성 확인

---