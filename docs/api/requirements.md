# Requirements Document

## 1. 스테이크홀더 요구사항

### 1.1 사용자(고객)
- 상품을 조회하고 장바구니에 담을 수 있어야 한다
- 포인트를 충전하여 결제 수단으로 사용할 수 있어야 한다
- 선착순 쿠폰을 발급받아 할인 혜택을 받을 수 있어야 한다
- 장바구니 상품을 주문하고 결제할 수 있어야 한다
- 주문 전체 또는 개별 상품을 취소하고 환불받을 수 있어야 한다
- 실시간으로 상품 재고를 확인할 수 있어야 한다

### 1.2 시스템 관리
- 외부 시스템으로 주문 데이터를 전송할 수 있어야 한다 (Outbox 패턴)
- 동시 다발적인 요청에도 데이터 정합성이 보장되어야 한다
- 트랜잭션 처리로 데이터 일관성이 유지되어야 한다

---

## 2. 기능적 요구사항

### 2.1 포인트 관리

#### FR-P-001: 포인트 충전
- **설명**: 사용자가 포인트를 충전하여 잔액을 증가시킬 수 있다
- **입력**: 사용자 ID, 충전 금액
- **출력**: 충전 후 잔액
- **비고**: 충전 이력이 기록되어야 한다

#### FR-P-002: 포인트 조회
- **설명**: 사용자가 현재 포인트 잔액을 조회할 수 있다
- **입력**: 사용자 ID
- **출력**: 현재 잔액

#### FR-P-003: 포인트 사용 이력 조회
- **설명**: 사용자가 포인트 충전/사용/환불 이력을 조회할 수 있다
- **입력**: 사용자 ID
- **출력**: 거래 내역 목록 (거래 유형, 금액, 거래 후 잔액, 거래 시간)

### 2.2 쿠폰 관리

#### FR-C-001: 선착순 쿠폰 발급
- **설명**: 사용자가 선착순으로 쿠폰을 발급받을 수 있다
- **입력**: 사용자 ID, 쿠폰 ID
- **출력**: 발급된 쿠폰 정보
- **비고**:
    - 수량이 소진되면 발급 불가
    - 동일 쿠폰 중복 발급 불가
    - 낙관적 락 또는 비관적 락 기반 동시성 제어

#### FR-C-002: 보유 쿠폰 조회
- **설명**: 사용자가 보유한 쿠폰 목록을 조회할 수 있다
- **입력**: 사용자 ID
- **출력**: 미사용 쿠폰 목록

### 2.3 상품 관리

#### FR-PR-001: 상품 목록 조회
- **설명**: 사용자가 판매 중인 상품 목록을 조회할 수 있다
- **입력**: 페이지 정보 (선택)
- **출력**: 상품 목록 (이름, 가격, 재고)

#### FR-PR-002: 상품 상세 조회
- **설명**: 사용자가 특정 상품의 상세 정보를 조회할 수 있다
- **입력**: 상품 ID
- **출력**: 상품 상세 정보

#### FR-PR-003: 실시간 재고 조회
- **설명**: 사용자가 특정 상품의 현재 재고를 실시간으로 조회할 수 있다
- **입력**: 상품 ID
- **출력**: 현재 재고 수량

### 2.4 장바구니 관리

#### FR-CA-001: 장바구니 상품 추가
- **설명**: 사용자가 상품을 장바구니에 추가할 수 있다
- **입력**: 사용자 ID, 상품 ID, 수량
- **출력**: 추가된 장바구니 아이템
- **비고**: 재고 수량 검증 필요

#### FR-CA-002: 장바구니 수량 변경
- **설명**: 사용자가 장바구니 상품의 수량을 변경할 수 있다
- **입력**: 장바구니 아이템 ID, 변경할 수량
- **출력**: 변경된 장바구니 아이템
- **비고**: 재고 수량 검증 필요

#### FR-CA-003: 장바구니 상품 삭제
- **설명**: 사용자가 장바구니에서 상품을 삭제할 수 있다
- **입력**: 장바구니 아이템 ID
- **출력**: 삭제 성공 여부

#### FR-CA-004: 장바구니 조회
- **설명**: 사용자가 장바구니에 담긴 상품 목록을 조회할 수 있다
- **입력**: 사용자 ID
- **출력**: 장바구니 아이템 목록 (상품 정보, 수량)

### 2.5 주문 관리

#### FR-O-001: 주문 생성 (핵심 비즈니스)
- **설명**: 사용자가 장바구니 상품을 주문하고 결제할 수 있다
- **입력**: 사용자 ID, 장바구니 아이템 ID 목록, 쿠폰 ID (선택)
- **처리 흐름**:
    1. 장바구니 아이템 조회 및 재고 검증
    2. 쿠폰 유효성 검증 (선택 시)
    3. 주문 금액 계산 (상품 합계 - 쿠폰 할인)
    4. 포인트 잔액 검증
    5. 주문 및 주문 아이템 생성 (상품 스냅샷 저장)
    6. 재고 차감
    7. 포인트 차감 및 이력 기록
    8. 쿠폰 사용 처리 (선택 시)
    9. 장바구니 정리
    10. 외부 연동 데이터 저장 (Outbox)
- **출력**: 생성된 주문 정보
- **비고**: 모든 처리는 트랜잭션 내에서 원자적으로 수행

#### FR-O-002: 주문 조회
- **설명**: 사용자가 자신의 주문 목록을 조회할 수 있다
- **입력**: 사용자 ID
- **출력**: 주문 목록 (주문 번호, 총 금액, 상태, 주문일시)

#### FR-O-003: 주문 상세 조회
- **설명**: 사용자가 특정 주문의 상세 정보를 조회할 수 있다
- **입력**: 주문 ID
- **출력**: 주문 상세 정보 (주문 아이템 목록 포함)

#### FR-O-004: 주문 전체 취소
- **설명**: 사용자가 주문 전체를 취소하고 환불받을 수 있다
- **입력**: 주문 ID
- **처리 흐름**:
    1. 주문 상태 검증 (PAID 또는 COMPLETED)
    2. 주문 및 주문 아이템 상태를 CANCELED로 변경
    3. 재고 복원
    4. 포인트 환불 및 이력 기록
    5. 쿠폰 복원 (사용했을 경우)
- **출력**: 취소된 주문 정보
- **비고**: 트랜잭션 내에서 원자적 처리

#### FR-O-005: 주문 아이템 개별 취소
- **설명**: 사용자가 주문 내 특정 상품만 취소하고 부분 환불받을 수 있다
- **입력**: 주문 아이템 ID
- **처리 흐름**:
    1. 주문 아이템 상태 검증 (NORMAL)
    2. 주문 아이템 상태를 CANCELED로 변경
    3. 해당 상품 재고 복원
    4. 취소 금액만큼 포인트 환불 및 이력 기록
- **출력**: 취소된 주문 아이템 정보
- **비고**: 트랜잭션 내에서 원자적 처리

### 2.6 외부 연동

#### FR-I-001: 주문 데이터 Outbox 저장
- **설명**: 주문 완료 시 외부 시스템 전송을 위해 Outbox 테이블에 기록한다
- **입력**: 주문 정보
- **출력**: Outbox 이벤트 ID
- **비고**: 실제 외부 전송 로직은 MVP에서 제외

---

## 3. 비기능적 요구사항

### 3.1 성능 (Performance)

#### NFR-P-001: 응답 시간
- 주요 API는 합리적인 응답 시간 내에 처리되어야 한다
- 조회 API는 빠른 응답이 필요하다

#### NFR-P-002: 동시 처리
- 동시 다발적인 요청을 안전하게 처리할 수 있어야 한다
- 쿠폰 선착순 발급, 재고 차감 등 동시성 제어가 필요하다

### 3.2 확장성 (Scalability)

#### NFR-S-001: 수평 확장
- 애플리케이션 서버는 수평 확장이 가능해야 한다
- Stateless 구조로 설계되어야 한다

### 3.3 신뢰성 (Reliability)

#### NFR-R-001: 데이터 일관성
- 주문 및 결제 처리는 ACID 트랜잭션을 보장해야 한다
- 재고 차감, 포인트 차감, 쿠폰 사용은 원자적으로 처리되어야 한다

#### NFR-R-002: 에러 처리
- 모든 예외 상황은 적절히 처리되고 로깅되어야 한다
- 사용자에게 명확한 에러 메시지를 제공해야 한다

### 3.4 유지보수성 (Maintainability)

#### NFR-M-001: 코드 품질
- 코드는 읽기 쉽고 유지보수가 용이해야 한다
- 계층형 아키텍처(Controller-Service-Repository)를 따라야 한다

#### NFR-M-002: 테스트
- 주요 비즈니스 로직은 테스트가 작성되어야 한다

---

## 4. 비즈니스 규칙 및 제약사항

### 4.1 비즈니스 규칙

#### BR-001: 결제 방식
- **규칙**: 결제는 포인트(잔액) 차감으로만 처리한다
- **근거**: MVP에서는 실제 PG 연동을 제외하고 간소화

#### BR-002: 재고 관리
- **규칙**: 재고는 상품 단위로만 관리한다 (옵션/조합 제외)
- **근거**: MVP 범위 단순화

#### BR-003: 동시성 제어
- **규칙**: 동시성 제어는 낙관적 락(Optimistic Lock)을 사용한다 (추후 비관적 락 도입 테스트)
- **적용 대상**: 포인트 차감, 재고 차감, 쿠폰 발급

#### BR-004: 쿠폰 발급 제한
- **규칙**: 동일 쿠폰은 사용자당 1회만 발급 가능하다

#### BR-005: 쿠폰 사용 조건
- **규칙**: 쿠폰은 발급받은 상태, 미사용 상태, 만료 전이어야 사용 가능하다

#### BR-006: 주문 취소 조건
- **규칙**: PAID 또는 COMPLETED 상태의 주문만 취소 가능하다

#### BR-007: 주문 아이템 개별 취소
- **규칙**: NORMAL 상태의 주문 아이템만 개별 취소 가능하다
- **효과**: 취소된 아이템 금액만큼 부분 환불 처리

#### BR-008: 재고 검증
- **규칙**: 장바구니 추가 시와 주문 생성 시 재고를 확인한다
- **실패 처리**: 재고 부족 시 전체 주문 롤백

#### BR-009: 상품 스냅샷 저장
- **규칙**: 주문 시점의 상품명과 가격을 주문 아이템에 저장한다
- **목적**: 주문 후 상품 정보 변경에 영향받지 않도록 함

### 4.2 기술적 제약사항

#### TC-001: MVP 범위
- 관리자 기능 제외
- 실제 PG 연동 제외 (포인트 결제만)
- 외부 데이터 전송 로직 제외 (Outbox 기록만)
- 상품 옵션/조합 관리 제외

#### TC-002: 기술 스택
- Java 17, Spring Boot 3.5.7
- 관계형 데이터베이스, JPA/Hibernate

#### TC-003: 트랜잭션 및 동시성
- Spring @Transactional 사용
- 낙관적 락(Optimistic Lock)으로 동시성 제어

#### TC-004: API 설계
- RESTful API 원칙 준수
- JSON 형식 요청/응답

### 4.3 데이터 제약사항

#### DC-001: 음수 방지
- 포인트 잔액, 재고 수량, 쿠폰 수량은 0 이상이어야 한다
- 주문 금액, 할인 금액은 양수여야 한다

#### DC-002: 금액 검증
- 할인 금액은 주문 금액을 초과할 수 없다
- 포인트 잔액은 사용 금액보다 크거나 같아야 한다

### 4.4 비즈니스 프로세스 제약

#### BPC-001: 원자성 보장
- 주문 생성/취소 시 모든 관련 작업은 원자적으로 처리되어야 한다

#### BPC-002: 동시성 제어
- 쿠폰 선착순 발급, 재고 차감 시 정확한 수량 보장이 필요하다

#### BPC-003: 데이터 정합성
- 취소/환불 시 차감했던 재고와 포인트가 정확히 복원되어야 한다

---

## 5. 요구사항 우선순위

### P0 (최우선 - MVP 필수)
- FR-O-001: 주문 생성 (핵심 비즈니스)
- FR-O-004: 주문 전체 취소
- FR-P-001: 포인트 충전
- FR-PR-001: 상품 목록 조회
- FR-CA-001: 장바구니 상품 추가
- NFR-R-001: 데이터 일관성

### P1 (높음 - MVP 포함)
- FR-C-001: 선착순 쿠폰 발급
- FR-O-005: 주문 아이템 개별 취소
- FR-PR-003: 실시간 재고 조회
- FR-CA-002: 장바구니 수량 변경
- NFR-P-002: 동시 처리

### P2 (중간 - MVP 이후)
- FR-P-003: 포인트 사용 이력 조회
- FR-C-002: 보유 쿠폰 조회
- FR-O-002: 주문 조회
- FR-O-003: 주문 상세 조회

### P3 (낮음 - 향후 개선)
- NFR-P-001: 응답 시간 최적화
- NFR-SE-002: 데이터 암호화
- NFR-M-002: 테스트 커버리지 확대

---

## 6. 제외 사항 (Out of Scope)

다음 기능은 MVP 범위(Week 2)에서 제외되며, 향후 버전에서 고려됩니다:

1. **관리자 기능**
    - 상품 등록/수정/삭제
    - 주문 관리
    - 쿠폰 생성/관리
    - 통계 및 리포트

2. **결제 고도화**
    - 실제 PG 연동 (신용카드, 계좌이체 등)
    - 다양한 결제 수단
    - 결제 취소/환불 처리 (PG 연동)

3. **상품 고도화**
    - 상품 옵션 관리
    - 상품 조합 관리
    - 상품 카테고리
    - 상품 검색 및 필터링

4. **쿠폰 고도화**
    - 다양한 할인 유형 (%, 금액, 배송비)
    - 쿠폰 사용 조건 (최소 주문 금액 등)
    - 중복 쿠폰 사용

5. **외부 연동**
    - Outbox 데이터 실제 전송
    - 외부 시스템 연동 (ERP, WMS 등)
    - 알림 발송 (이메일, SMS)

---

## 7. 리스크 및 완화 전략

### 리스크 1: 동시성 이슈 (재고, 쿠폰)
- **영향도**: 높음
- **완화 전략**: 낙관적 락 또는 비관적 락 적용 및 검증 로직 강화

### 리스크 2: 주문 처리 중 데이터 불일치
- **영향도**: 높음
- **완화 전략**: 트랜잭션 처리 및 롤백 로직 철저히 구현

### 리스크 3: 대량 트래픽으로 인한 성능 저하
- **영향도**: 중간
- **완화 전략**: 캐싱 전략, 인덱스 최적화

### 리스크 4: Outbox 테이블 무한 증가
- **영향도**: 낮음
- **완화 전략**: 주기적인 정리 작업 계획 수립

---

## 문서 이력

| 버전 | 날짜         | 작성자 | 변경 내용 |
|------|------------|--------|-----------|
| 1.0  | 2025-10-30 | -      | 초안 작성 |